<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Job Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Job Portal</div>
            </div>
            <nav class="sidebar-nav">
                <ul id="sidebar-nav-list">
                    <!-- Dynamic links will be loaded here -->
                </ul>
            </nav>
        </aside>
        <div class="main-content">
            <header class="header">
                <div class="header-content">
                    <h1>Dashboard</h1>
                </div>
            </header>
            <main>
                <div id="content">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </main>
        </div>
    </div>
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="share-links">
                <button class="share-btn fb"><i class="fab fa-facebook-f"></i> Facebook</button>
                <button class="share-btn tw"><i class="fab fa-twitter"></i> Twitter</button>
                <button class="share-btn li"><i class="fab fa-linkedin-in"></i> LinkedIn</button>
                <button class="share-btn em"><i class="fas fa-envelope"></i> Email</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Existing imports
        import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {getDatabase, ref, get, set, update, remove, push} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import {getStorage, ref as storageRef, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQV3GEG6NsuxH3OJgjcd0blak5tRsO89g",
            authDomain: "loginform-dbe79.firebaseapp.com",
            projectId: "loginform-dbe79",
            storageBucket: "loginform-dbe79.appspot.com",
            messagingSenderId: "615553042710",
            appId: "1:615553042710:web:e6f0264a9506c02e1fa837"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', function () {
            const username = sessionStorage.getItem('username');
            const role = sessionStorage.getItem('role');

            if (!username || !role) {
                window.location.href = 'login.html';
                return;
            }

            function setUpDashboard(role) {
                const sidebarNavList = document.getElementById('sidebar-nav-list');
                sidebarNavList.innerHTML = '';

                if (role === 'job-seeker') {
                    sidebarNavList.innerHTML = `
                        <li><a href="#" id="profile-link"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a href="#" id="update-profile-link"><i class="fas fa-edit"></i> Update Profile</a></li>
                        <li><a href="#" id="cv-builder-link"><i class="fas fa-file-alt"></i> CV Builder</a></li>
                        <li><a href="#" id="job-listings-link"><i class="fas fa-briefcase"></i> Job Listings</a></li>
                        <li><a href="#" id="applications-link"><i class="fas fa-file-alt"></i> Applications</a></li>
                        <li><a href="#" id="job-alerts-link"><i class="fas fa-bell"></i> Job Alerts</a></li>
                        <li><a href="#" id="application-tracking-link"><i class="fas fa-tasks"></i> Application Tracking</a></li>
                        <li><a href="#" id="messages-link"><i class="fas fa-envelope"></i> Messages from Employers</a></li>
                        <li><a href="#" id="scheduled-interviews-link"><i class="fas fa-calendar-alt"></i> Scheduled Interviews</a></li>
                        <li><a href="#" id="saved-jobs-link"><i class="fas fa-bookmark"></i> Saved Jobs</a></li>
                        <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    `;
                } else if (role === 'employer') {
                    sidebarNavList.innerHTML = `
                    <li><a href="#" id="profile-link"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#" id="job-postings-link"><i class="fas fa-plus-circle"></i> Job Postings</a></li>
                    <li><a href="#" id="applicants-link"><i class="fas fa-users"></i> Applicants</a></li>
                    <li><a href="#" id="company-profiles-link"><i class="fas fa-building"></i> Company Profiles</a></li>
                    <li><a href="#" id="job-analytics-link"><i class="fas fa-chart-bar"></i> Job Analytics</a></li>
                    <li><a href="#" id="bulk-job-upload-link"><i class="fas fa-upload"></i> Bulk Job Upload</a></li>
                    <li><a href="#" id="candidate-management-link"><i class="fas fa-user-cog"></i> Candidate Management</a></li>
                    <li><a href="#" id="messages-link"><i class="fas fa-envelope"></i> Messages from Job Seekers</a></li>
                    <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                  `;
                } else if (role === 'admin') {
                    sidebarNavList.innerHTML = `
                        <li><a href="#" id="profile-link"><i class="fas fa-user-shield"></i> Admin Profile</a></li>
                        <li><a href="#" id="job-postings-link"><i class="fas fa-plus-circle"></i> Job Postings</a></li>
                        <li><a href="#" id="applicants-link"><i class="fas fa-users"></i> Applicants</a></li>
                        <li><a href="#" id="manage-users-link"><i class="fas fa-user-cog"></i> Manage Users</a></li>
                        <li><a href="#" id="content-moderation-link"><i class="fas fa-gavel"></i> Content Moderation</a></li>
                        <li><a href="#" id="analytics-link"><i class="fas fa-chart-pie"></i> Analytics</a></li>
                        <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    `;
                }

                setUpEventListeners(role);
            }

            function setUpEventListeners(role) {

                const profileLink = document.getElementById("profile-link");
                if (profileLink) {
                    profileLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadProfile(role);
                    });
                }

                const messagesLink = document.getElementById("messages-link");
                if (messagesLink) {
                    messagesLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (role === 'employer') {
                            loadMessagesForEmployer();
                        } else {
                            loadMessages();
                        }
                    });
                }

                const updateProfileLink = document.getElementById("update-profile-link");
                if (updateProfileLink) {
                    updateProfileLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadUpdateProfileForm();
                    });
                }

                const cvBuilderLink = document.getElementById("cv-builder-link");
                if (cvBuilderLink) {
                    cvBuilderLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadCVBuilder();
                    });
                }

                const jobAlertsLink = document.getElementById("job-alerts-link");
                if (jobAlertsLink) {
                    jobAlertsLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadJobAlertsForm();
                    });
                }

                const applicationTrackingLink = document.getElementById("application-tracking-link");
                if (applicationTrackingLink) {
                    applicationTrackingLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadApplicationTracking();
                    });
                }


                const scheduledInterviewsLink = document.getElementById("scheduled-interviews-link");
                if (scheduledInterviewsLink) {
                    scheduledInterviewsLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadScheduledInterviews();
                    });
                }

                const savedJobsLink = document.getElementById("saved-jobs-link");
                if (savedJobsLink) {
                    savedJobsLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        loadSavedJobs();
                    });
                }

                if (role === 'job-seeker') {
                    const jobListingsLink = document.getElementById("job-listings-link");
                    const applicationsLink = document.getElementById("applications-link");

                    if (jobListingsLink) {
                        jobListingsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadJobListings();
                        });
                    }

                    if (applicationsLink) {
                        applicationsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadApplications();
                        });
                    }
                } else {
                    const jobPostingsLink = document.getElementById("job-postings-link");
                    const applicantsLink = document.getElementById("applicants-link");
                    const companyProfilesLink = document.getElementById("company-profiles-link");
                    const jobAnalyticsLink = document.getElementById("job-analytics-link");
                    const bulkJobUploadLink = document.getElementById("bulk-job-upload-link");
                    const candidateManagementLink = document.getElementById("candidate-management-link");
                    const manageUsersLink = document.getElementById("manage-users-link");
                    const contentModerationLink = document.getElementById("content-moderation-link");
                    const analyticsLink = document.getElementById("analytics-link");

                    if (jobPostingsLink) {
                        jobPostingsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadJobPostings();
                        });
                    }

                    if (applicantsLink) {
                        applicantsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadApplicants();
                        });
                    }

                    if (companyProfilesLink) {
                        companyProfilesLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadCompanyProfiles();
                        });
                    }

                    if (jobAnalyticsLink) {
                        jobAnalyticsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadJobAnalytics();
                        });
                    }

                    if (bulkJobUploadLink) {
                        bulkJobUploadLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadBulkJobUploadForm();
                        });
                    }

                    if (candidateManagementLink) {
                        candidateManagementLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadCandidateManagement();
                        });
                    }

                    if (manageUsersLink) {
                        manageUsersLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadManageUsers();
                        });
                    }

                    if (contentModerationLink) {
                        contentModerationLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadContentModeration();
                        });
                    }

                    if (analyticsLink) {
                        analyticsLink.addEventListener('click', function (e) {
                            e.preventDefault();
                            loadAnalytics();
                        });
                    }
                }

                const logoutLink = document.getElementById("logout-link");
                if (logoutLink) {
                    logoutLink.addEventListener('click', function (e) {
                        e.preventDefault();
                        alert("Logged out successfully!");
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    });
                }
            }

            function shareJob(jobId) {
                get(ref(db, `jobs/${jobId}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const job = snapshot.val();
                        const jobTitle = job.title;
                        const jobCompany = job.company;
                        const jobLocation = job.location;
                        const jobDescription = job.description;

                        const jobUrl = `${window.location.href}?jobId=${jobId}`;
                        const shareText = `Check out this job: ${jobTitle} at ${jobCompany}, located in ${jobLocation}. Job Description: ${jobDescription}. Link: ${jobUrl}`;

                        const shareOptions = [
                            {name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(jobUrl)}`, class: 'facebook', icon: 'fab fa-facebook-f'},
                            {name: 'Twitter', url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, class: 'twitter', icon: 'fab fa-twitter'},
                            {name: 'LinkedIn', url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(jobUrl)}`, class: 'linkedin', icon: 'fab fa-linkedin-in'},
                            {name: 'Email', url: `mailto:?subject=Job Opportunity: ${jobTitle} at ${jobCompany}&body=${encodeURIComponent(shareText)}`, class: 'email', icon: 'fas fa-envelope'},
                        ];

                        let shareLinksHTML = '<h3>Share this job:</h3>';
                        shareOptions.forEach(option => {
                            shareLinksHTML += `<a href="${option.url}" target="_blank" class="${option.class}">${option.name}</a>`;
                        });

                        // Show modal with share links
                        const modal = document.getElementById("shareModal");
                        const modalContent = document.querySelector(".modal-content .share-links");
                        modalContent.innerHTML = shareLinksHTML;
                        modal.style.display = "block";

                        // Close the modal
                        const span = document.getElementsByClassName("close")[0];
                        span.onclick = function () {
                            modal.style.display = "none";
                        }
                        window.onclick = function (event) {
                            if (event.target == modal) {
                                modal.style.display = "none";
                            }
                        }
                    } else {
                        alert("Job not found.");
                    }
                }).catch((error) => {
                    console.error(error);
                    alert("Error retrieving job details.");
                });
            }

            function loadMessagesForEmployer() {
                const username = sessionStorage.getItem('username');
                document.getElementById("content").innerHTML = `
                    <h2>Messages</h2>
                    <div id="message-list"></div>
                    <form id="message-form">
                        <div class="input-group">
                            <label for="receiver">Receiver:</label>
                            <select id="receiver" required></select>
                        </div>
                        <div class="input-group">
                            <label for="message">Message:</label>
                            <textarea id="message" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Send Message</button>
                    </form>
                `;

                // Fetch and display messages
                get(ref(db, `messages/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const messages = snapshot.val();
                        let messagesHTML = '<ul>';
                        for (const messageId in messages) {
                            const message = messages[messageId];
                            messagesHTML += `<li>${message.date}: ${message.from} - ${message.message}</li>`;
                        }
                        messagesHTML += '</ul>';
                        document.getElementById("message-list").innerHTML = messagesHTML;
                    } else {
                        document.getElementById("message-list").innerHTML = '<p>No messages found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("message-list").innerHTML = '<p>Error loading messages.</p>';
                });

                // Fetch potential recipients (employers)
                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const receiverSelect = document.getElementById("receiver");
                        for (const userId in users) {
                            const user = users[userId];
                            if (user.Role === 'job-seeker') {
                                const option = document.createElement('option');
                                option.value = userId;
                                option.text = user.Email; // or user.Username
                                receiverSelect.appendChild(option);
                            }
                        }
                    }
                }).catch((error) => {
                    console.error(error);
                });

                document.getElementById("message-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const receiver = document.getElementById("receiver").value;
                    const message = document.getElementById("message").value;

                    const newMessageRef = push(ref(db, `messages/${receiver}`));
                    set(newMessageRef, {
                        from: username,
                        message,
                        date: new Date().toISOString()
                    }).then(() => {
                        alert("Message sent successfully!");
                        loadMessages();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error sending message.");
                    });
                });
            }

            function loadMessages() {
                const username = sessionStorage.getItem('username');
                document.getElementById("content").innerHTML = `
                    <h2>Messages</h2>
                    <div id="message-list"></div>
                    <form id="message-form">
                        <div class="input-group">
                            <label for="receiver">Receiver:</label>
                            <select id="receiver" required></select>
                        </div>
                        <div class="input-group">
                            <label for="message">Message:</label>
                            <textarea id="message" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Send Message</button>
                    </form>
                `;

                // Fetch and display messages
                get(ref(db, `messages/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const messages = snapshot.val();
                        let messagesHTML = '<ul>';
                        for (const messageId in messages) {
                            const message = messages[messageId];
                            messagesHTML += `<li>${message.date}: ${message.from} - ${message.message}</li>`;
                        }
                        messagesHTML += '</ul>';
                        document.getElementById("message-list").innerHTML = messagesHTML;
                    } else {
                        document.getElementById("message-list").innerHTML = '<p>No messages found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("message-list").innerHTML = '<p>Error loading messages.</p>';
                });

                // Fetch potential recipients (employers)
                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const receiverSelect = document.getElementById("receiver");
                        for (const userId in users) {
                            const user = users[userId];
                            if (user.Role === 'employer') {
                                const option = document.createElement('option');
                                option.value = userId;
                                option.text = user.Email; // or user.Username
                                receiverSelect.appendChild(option);
                            }
                        }
                    }
                }).catch((error) => {
                    console.error(error);
                });

                document.getElementById("message-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const receiver = document.getElementById("receiver").value;
                    const message = document.getElementById("message").value;

                    const newMessageRef = push(ref(db, `messages/${receiver}`));
                    set(newMessageRef, {
                        from: username,
                        message,
                        date: new Date().toISOString()
                    }).then(() => {
                        alert("Message sent successfully!");
                        loadMessages();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error sending message.");
                    });
                });
            }

            function loadProfile(role) {
                const username = sessionStorage.getItem('username');
                get(ref(db, `users/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        document.getElementById("content").innerHTML = `
                            <h2>Profile</h2>
                            <p>Username: ${userData.Username}</p>
                            <p>Email: ${userData.Email}</p>
                            <p>Role: ${userData.Role}</p>
                            ${userData.ProfilePicture ? `<img src="${userData.ProfilePicture}" alt="Profile Picture" width="150" height="150">` : ''}
                            <p>Experience: ${userData.Experience || ''}</p>
                            <p>Education: ${userData.Education || ''}</p>
                            <p>Skills: ${userData.Skills || ''}</p>
                        `;
                    } else {
                        document.getElementById("content").innerHTML = '<p>No user data found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading profile.</p>';
                });
            }

            function loadUpdateProfileForm() {
                document.getElementById("content").innerHTML = `
                    <h2>Update Profile</h2>
                    <form id="update-profile-form">
                        <div class="input-group">
                            <label for="profile-picture">Profile Picture:</label>
                            <input type="file" id="profile-picture" accept="image/*">
                        </div>
                        <div class="input-group">
                            <label for="experience">Experience:</label>
                            <textarea id="experience" rows="4"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="education">Education:</label>
                            <textarea id="education" rows="4"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="skills">Skills:</label>
                            <textarea id="skills" rows="4"></textarea>
                        </div>
                        <button type="submit" class="auth-button">Update Profile</button>
                    </form>
                `;

                document.getElementById("update-profile-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const username = sessionStorage.getItem('username');
                    const experience = document.getElementById("experience").value;
                    const education = document.getElementById("education").value;
                    const skills = document.getElementById("skills").value;
                    const profilePictureInput = document.getElementById("profile-picture");
                    const profilePictureFile = profilePictureInput.files[0];

                    if (profilePictureFile) {
                        const profilePictureRef = storageRef(storage, `profile_pictures/${username}`);
                        uploadBytes(profilePictureRef, profilePictureFile).then((snapshot) => {
                            getDownloadURL(snapshot.ref).then((url) => {
                                updateProfile(username, experience, education, skills, url);
                            }).catch((error) => {
                                console.error(error);
                                alert("Error uploading profile picture.");
                            });
                        }).catch((error) => {
                            console.error(error);
                            alert("Error uploading profile picture.");
                        });
                    } else {
                        updateProfile(username, experience, education, skills);
                    }
                });
            }

            function updateProfile(username, experience, education, skills, profilePictureUrl) {
                const updates = {
                    Experience: experience,
                    Education: education,
                    Skills: skills
                };

                if (profilePictureUrl) {
                    updates.ProfilePicture = profilePictureUrl;
                }

                update(ref(db, `users/${username}`), updates).then(() => {
                    alert("Profile updated successfully!");
                    loadProfile('job-seeker');
                }).catch((error) => {
                    console.error(error);
                    alert("Error updating profile.");
                });
            }

            function loadJobAlertsForm() {
                document.getElementById("content").innerHTML = `
                    <h2>Job Alerts</h2>
                    <form id="job-alerts-form">
                        <div class="input-group">
                            <label for="alert-name">Alert Name:</label>
                            <input type="text" id="alert-name" required>
                        </div>
                        <div class="input-group">
                            <label for="job-title">Job Title:</label>
                            <input type="text" id="job-title">
                        </div>
                        <div class="input-group">
                            <label for="job-category">Job Category:</label>
                            <input type="text" id="job-category">
                        </div>
                        <div class="input-group">
                            <label for="location">Location:</label>
                            <input type="text" id="location">
                        </div>
                        <button type="submit" class="auth-button">Create Alert</button>
                    </form>
                    <div id="existing-alerts">
                        <h3>Existing Alerts</h3>
                        <ul id="alerts-list"></ul>
                    </div>
                `;

                document.getElementById("job-alerts-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const alertName = document.getElementById("alert-name").value;
                    const jobTitle = document.getElementById("job-title").value;
                    const jobCategory = document.getElementById("job-category").value;
                    const location = document.getElementById("location").value;

                    const newAlertRef = push(ref(db, `job_alerts/${username}`));
                    set(newAlertRef, {
                        alertName,
                        jobTitle,
                        jobCategory,
                        location
                    }).then(() => {
                        alert("Job alert created successfully!");
                        loadJobAlertsForm();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error creating job alert.");
                    });
                });

                loadExistingAlerts();
            }

            function loadExistingAlerts() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `job_alerts/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const alerts = snapshot.val();
                        let alertsListHTML = '';
                        for (const alertId in alerts) {
                            const alert = alerts[alertId];
                            alertsListHTML += `
                                <li>
                                    ${alert.alertName} - ${alert.jobTitle || ''} ${alert.jobCategory || ''} ${alert.location || ''}
                                    <button class="delete-alert-button" data-alert-id="${alertId}">Delete</button>
                                </li>
                            `;
                        }
                        document.getElementById("alerts-list").innerHTML = alertsListHTML;

                        document.querySelectorAll('.delete-alert-button').forEach(button => {
                            button.addEventListener('click', function () {
                                deleteAlert(button.getAttribute('data-alert-id'));
                            });
                        });
                    } else {
                        document.getElementById("alerts-list").innerHTML = '<p>No job alerts found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("alerts-list").innerHTML = '<p>Error loading job alerts.</p>';
                });
            }

            function deleteAlert(alertId) {
                const username = sessionStorage.getItem('username');
                update(ref(db, `job_alerts/${username}/${alertId}`), null).then(() => {
                    alert("Job alert deleted successfully!");
                    loadJobAlertsForm();
                }).catch((error) => {
                    console.error(error);
                    alert("Error deleting job alert.");
                });
            }

            function loadJobListings() {
                document.getElementById("content").innerHTML = `
                    <h2>Job Listings</h2>
                    <div class="search-container">
                        <input type="text" id="search-bar" placeholder="Search for jobs by title or category...">
                    </div>
                    <div id="map" style="height: 400px; width: 100%;"></div>
                    <div id="job-listings" class="job-listings"></div>
                `;

                // Initialize Leaflet Map
                const map = L.map('map').setView([39.8283, -98.5795], 4); // Center map to USA

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add Geocoder search control to the map
                const geocoder = L.Control.Geocoder.nominatim();
                L.Control.geocoder({
                    query: '',
                    placeholder: 'Search for a location...',
                    defaultMarkGeocode: true,
                    geocoder: geocoder
                }).addTo(map);

                get(ref(db, 'jobs')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const jobs = snapshot.val();
                        const categories = {};

                        for (const jobId in jobs) {
                            const job = jobs[jobId];
                            if (!categories[job.category]) {
                                categories[job.category] = [];
                            }
                            categories[job.category].push({
                                id: jobId,
                                title: job.title,
                                company: job.company,
                                location: job.location,
                                category: job.category,
                                tags: job.tags || [],
                                lat: job.lat,
                                lng: job.lng
                            });

                            // Add marker to map
                            if (job.lat && job.lng) {
                                L.marker([job.lat, job.lng]).addTo(map)
                                    .bindPopup(`<b>${job.title}</b><br>${job.company}<br>${job.location}`);
                            }
                        }

                        let jobListHTML = '';
                        for (const category in categories) {
                            jobListHTML += `<h3>${category}</h3><div class="job-category">`;
                            categories[category].forEach(job => {
                                jobListHTML += `
                                    <div class="job-card">
                                        <h4>${job.title}</h4>
                                        <p><strong>Company:</strong> ${job.company}</p>
                                        <p><strong>Location:</strong> ${job.location}</p>
                                        <div class="tags">
                                            ${job.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                        </div>
                                        <div class="job-actions">
                                            <button class="apply-button" data-job-id="${job.id}"><i class="fas fa-paper-plane"></i> Apply</button>
                                            <button class="save-button" data-job-id="${job.id}"><i class="fas fa-bookmark"></i> Save Job</button>
                                            <button class="report-button" data-job-id="${job.id}"><i class="fas fa-flag"></i> Report</button>
                                            <button class="share-button" data-job-id="${job.id}"><i class="fas fa-share"></i> Share Job</button>
                                        </div>
                                    </div>
                                `;
                            });
                            jobListHTML += '</div>';
                        }

                        document.getElementById("job-listings").innerHTML = jobListHTML;

                        document.querySelectorAll('.apply-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadApplicationForm(button.getAttribute('data-job-id'));
                            });
                        });

                        document.querySelectorAll('.save-button').forEach(button => {
                            button.addEventListener('click', function () {
                                saveJob(button.getAttribute('data-job-id'));
                            });
                        });

                        document.querySelectorAll('.report-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadReportForm(button.getAttribute('data-job-id'));
                            });
                        });

                        document.querySelectorAll('.share-button').forEach(button => {
                            button.addEventListener('click', function () {
                                shareJob(button.getAttribute('data-job-id'));
                            });
                        });

                        document.getElementById('search-bar').addEventListener('input', function () {
                            filterJobs(this.value.toLowerCase(), categories);
                        });
                    } else {
                        document.getElementById("job-listings").innerHTML = '<p>No job listings found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("job-listings").innerHTML = '<p>Error loading job listings.</p>';
                });
            }


            function filterJobs(query, categories) {
                let jobListHTML = '';
                for (const category in categories) {
                    let filteredJobs = categories[category].filter(job =>
                        job.title.toLowerCase().includes(query) ||
                        job.company.toLowerCase().includes(query) ||
                        job.location.toLowerCase().includes(query) ||
                        job.category.toLowerCase().includes(query) ||
                        job.tags.some(tag => tag.toLowerCase().includes(query))
                    );

                    if (filteredJobs.length > 0) {
                        jobListHTML += `<h3>${category}</h3><ul>`;
                        filteredJobs.forEach(job => {
                            jobListHTML += `
                                <li>
                                    ${job.title} at ${job.company} - ${job.location}
                                    <div class="tags">
                                        ${job.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                    <button class="apply-button" data-job-id="${job.id}">Apply</button>
                                    <button class="save-button" data-job-id="${job.id}">Save Job</button>
                                    <button class="report-button" data-job-id="${job.id}">Report</button>
                                </li>
                            `;
                        });
                        jobListHTML += '</ul>';
                    }
                }

                document.getElementById("job-listings").innerHTML = jobListHTML;

                document.querySelectorAll('.apply-button').forEach(button => {
                    button.addEventListener('click', function () {
                        loadApplicationForm(button.getAttribute('data-job-id'));
                    });
                });

                document.querySelectorAll('.save-button').forEach(button => {
                    button.addEventListener('click', function () {
                        saveJob(button.getAttribute('data-job-id'));
                    });
                });

                document.querySelectorAll('.report-button').forEach(button => {
                    button.addEventListener('click', function () {
                        loadReportForm(button.getAttribute('data-job-id'));
                    });
                });
            }

            function saveJob(jobId) {
                const username = sessionStorage.getItem('username');
                get(ref(db, `jobs/${jobId}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const job = snapshot.val();
                        const savedJobRef = push(ref(db, `saved_jobs/${username}`));
                        set(savedJobRef, job).then(() => {
                            alert("Job saved successfully!");
                        }).catch((error) => {
                            console.error(error);
                            alert("Error saving job.");
                        });
                    } else {
                        alert("Job not found.");
                    }
                }).catch((error) => {
                    console.error(error);
                    alert("Error retrieving job details.");
                });
            }

            function loadApplications() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `applications/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const applications = snapshot.val();
                        let applicationsHTML = '<h2>Applications</h2><div class="applications-container">';
                        for (const appId in applications) {
                            const application = applications[appId];
                            applicationsHTML += `
                                <div class="application-card">
                                    <h3>${application.jobTitle}</h3>
                                    <p><strong>Company:</strong> ${application.company}</p>
                                    <p><strong>Status:</strong> ${application.status}</p>
                                    <p><strong>Applied on:</strong> ${application.appliedDate}</p>
                                    <div class="application-actions">
                                        <button class="view-cv-button" data-cv-url="${application.cvUrl}"><i class="fas fa-file-alt"></i> View CV</button>
                                    </div>
                                </div>
                            `;
                        }
                        applicationsHTML += '</div>';
                        document.getElementById("content").innerHTML = applicationsHTML;

                        document.querySelectorAll('.view-cv-button').forEach(button => {
                            button.addEventListener('click', function () {
                                window.open(button.getAttribute('data-cv-url'), '_blank');
                            });
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>No applications found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading applications.</p>';
                });
            }

            function loadApplicationTracking() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `applications/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const applications = snapshot.val();
                        let trackingHTML = '<h2>Application Tracking</h2><ul>';
                        for (const appId in applications) {
                            const application = applications[appId];
                            trackingHTML += `<li>${application.jobTitle} at ${application.company} - Status: ${application.status}</li>`;
                        }
                        trackingHTML += '</ul>';
                        document.getElementById("content").innerHTML = trackingHTML;
                    } else {
                        document.getElementById("content").innerHTML = '<p>No applications found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading application tracking.</p>';
                });
            }

            function loadJobPostings() {
                document.getElementById("content").innerHTML = `
                    <h2>Post a Job</h2>
                    <form id="job-posting-form">
                        <div class="input-group">
                            <label for="job-title">Job Title:</label>
                            <input type="text" id="job-title" required>
                        </div>
                        <div class="input-group">
                            <label for="company">Company:</label>
                            <input type="text" id="company" required>
                        </div>
                        <div class="input-group">
                            <label for="location">Location:</label>
                            <input type="text" id="location" required>
                        </div>
                        <div class="input-group">
                            <label for="category">Category:</label>
                            <input type="text" id="category" required>
                        </div>
                        <div class="input-group">
                            <label for="tags">Tags (comma-separated):</label>
                            <input type="text" id="tags">
                        </div>
                        <div class="input-group">
                            <label for="description">Description:</label>
                            <textarea id="description" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Post Job</button>
                    </form>
                `;

                document.getElementById("job-posting-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const title = document.getElementById("job-title").value;
                    const company = document.getElementById("company").value;
                    const location = document.getElementById("location").value;
                    const category = document.getElementById("category").value;
                    const description = document.getElementById("description").value;
                    const tags = document.getElementById("tags").value.split(',').map(tag => tag.trim());

                    const newJobRef = push(ref(db, 'jobs'));
                    set(newJobRef, {
                        title,
                        company,
                        location,
                        category,
                        description,
                        tags
                    }).then(() => {
                        alert("Job posted successfully!");
                        loadJobListings();
                        checkJobAlerts(title, category, location);
                    }).catch((error) => {
                        console.error(error);
                        alert("Error posting job.");
                    });
                });
            }

            function loadApplicants() {
                get(ref(db, 'applications')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const applications = snapshot.val();
                        const jobApplicants = {};

                        for (const username in applications) {
                            for (const appId in applications[username]) {
                                const application = applications[username][appId];
                                if (!jobApplicants[application.jobTitle]) {
                                    jobApplicants[application.jobTitle] = [];
                                }
                                jobApplicants[application.jobTitle].push({
                                    username,
                                    company: application.company,
                                    status: application.status,
                                    cvUrl: application.cvUrl,
                                    appId
                                });
                            }
                        }

                        let applicantsHTML = '<h2>Applicants</h2>';
                        applicantsHTML += '<div class="moderation-container" id="applicants-list">';
                        for (const jobTitle in jobApplicants) {
                            applicantsHTML += `<h3>${jobTitle}</h3>`;
                            jobApplicants[jobTitle].forEach(applicant => {
                                applicantsHTML += `
                                    <div class="moderation-item">
                                        <p><strong>Username:</strong> ${applicant.username}</p>
                                        <p><strong>Company:</strong> ${applicant.company}</p>
                                        <p><strong>Status:</strong> ${applicant.status}</p>
                                        <a href="${applicant.cvUrl}" target="_blank">View CV</a>
                                        <div class="moderation-actions">
                                            <button class="schedule-interview-button" data-job-title="${jobTitle}" data-username="${applicant.username}" data-app-id="${applicant.appId}">Schedule Interview</button>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        applicantsHTML += '</div>';

                        document.getElementById("content").innerHTML = applicantsHTML;

                        document.querySelectorAll('.schedule-interview-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadInterviewForm(button.getAttribute('data-job-title'), button.getAttribute('data-username'), button.getAttribute('data-app-id'));
                            });
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>No applicants found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading applicants.</p>';
                });
            }

            function shareJob(jobId) {
                get(ref(db, `jobs/${jobId}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const job = snapshot.val();
                        const jobTitle = job.title;
                        const jobCompany = job.company;
                        const jobLocation = job.location;
                        const jobDescription = job.description;

                        const jobUrl = `${window.location.href}?jobId=${jobId}`;
                        const shareText = `Check out this job: ${jobTitle} at ${jobCompany}, located in ${jobLocation}. Job Description: ${jobDescription}. Link: ${jobUrl}`;

                        const shareOptions = [
                            { name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(jobUrl)}`, class: 'facebook' },
                            { name: 'Twitter', url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, class: 'twitter' },
                            { name: 'LinkedIn', url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(jobUrl)}`, class: 'linkedin' },
                            { name: 'Email', url: `mailto:?subject=Job Opportunity: ${jobTitle} at ${jobCompany}&body=${encodeURIComponent(shareText)}`, class: 'email' },
                        ];

                        let shareLinksHTML = '<h3>Share this job:</h3>';
                        shareOptions.forEach(option => {
                            shareLinksHTML += `<a href="${option.url}" target="_blank" class="${option.class}">${option.name}</a>`;
                        });

                        // Show modal with share links
                        const modal = document.getElementById("shareModal");
                        const modalContent = document.querySelector(".modal-content .share-links");
                        modalContent.innerHTML = shareLinksHTML;
                        modal.style.display = "block";

                        // Close the modal
                        const span = document.getElementsByClassName("close")[0];
                        span.onclick = function () {
                            modal.style.display = "none";
                        }
                        window.onclick = function (event) {
                            if (event.target == modal) {
                                modal.style.display = "none";
                            }
                        }
                    } else {
                        alert("Job not found.");
                    }
                }).catch((error) => {
                    console.error(error);
                    alert("Error retrieving job details.");
                });
            }

            function loadInterviewForm(jobTitle, username, appId) {
                document.getElementById("content").innerHTML = `
                    <h2>Schedule Interview for ${jobTitle}</h2>
                    <form id="interview-form">
                        <div class="input-group">
                            <label for="interview-date">Interview Date:</label>
                            <input type="date" id="interview-date" required>
                        </div>
                        <button type="submit" class="auth-button">Schedule Interview</button>
                    </form>
                `;

                document.getElementById("interview-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const interviewDate = document.getElementById("interview-date").value;

                    if (!interviewDate) {
                        alert("Please select an interview date.");
                        return;
                    }

                    const interviewData = {
                        interviewDate,
                        status: 'Interview Scheduled'
                    };

                    update(ref(db, `applications/${username}/${appId}`), interviewData).then(() => {
                        alert("Interview scheduled successfully!");
                        loadApplicants();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error scheduling interview.");
                    });
                });
            }

            function loadScheduledInterviews() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `applications/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const applications = snapshot.val();
                        let interviewsHTML = '<h2>Scheduled Interviews</h2><ul>';
                        for (const appId in applications) {
                            const application = applications[appId];
                            if (application.status === 'Interview Scheduled') {
                                interviewsHTML += `<li>${application.jobTitle} at ${application.company} - Interview Date: ${application.interviewDate}</li>`;
                            }
                        }
                        interviewsHTML += '</ul>';
                        document.getElementById("content").innerHTML = interviewsHTML;
                    } else {
                        document.getElementById("content").innerHTML = '<p>No scheduled interviews found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading scheduled interviews.</p>';
                });
            }

            function loadApplicationForm(jobId) {
                document.getElementById("content").innerHTML = `
                    <h2>Apply for Job</h2>
                    <form id="application-form">
                        <div class="input-group">
                            <label for="cover-letter">Cover Letter:</label>
                            <textarea id="cover-letter" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="cv">Upload CV:</label>
                            <input type="file" id="cv" accept=".pdf,.doc,.docx" required>
                        </div>
                        <button type="submit" class="auth-button">Submit Application</button>
                    </form>
                `;

                document.getElementById("application-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const username = sessionStorage.getItem('username');
                    const coverLetter = document.getElementById("cover-letter").value;
                    const cvInput = document.getElementById("cv");
                    const cvFile = cvInput.files[0];

                    if (cvFile) {
                        const cvRef = storageRef(storage, `cv/${username}/${cvFile.name}`);
                        uploadBytes(cvRef, cvFile).then((snapshot) => {
                            getDownloadURL(snapshot.ref).then((url) => {
                                submitApplication(jobId, username, coverLetter, url);
                            }).catch((error) => {
                                console.error(error);
                                alert("Error uploading CV.");
                            });
                        }).catch((error) => {
                            console.error(error);
                            alert("Error uploading CV.");
                        });
                    }
                });
            }

            function submitApplication(jobId, username, coverLetter, cvUrl) {
                const newApplicationRef = push(ref(db, `applications/${username}`));
                set(newApplicationRef, {
                    jobId,
                    coverLetter,
                    cvUrl,
                    status: 'Pending'
                }).then(() => {
                    alert("Application submitted successfully!");
                    loadApplications();
                }).catch((error) => {
                    console.error(error);
                    alert("Error submitting application.");
                });
            }

            function loadReportForm(jobId) {
                document.getElementById("content").innerHTML = `
                    <h2>Report Job</h2>
                    <form id="report-form">
                        <div class="input-group">
                            <label for="report-reason">Reason for Reporting:</label>
                            <textarea id="report-reason" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Submit Report</button>
                    </form>
                `;

                document.getElementById("report-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const username = sessionStorage.getItem('username');
                    const reason = document.getElementById("report-reason").value;

                    const newReportRef = push(ref(db, `reports/${jobId}`));
                    set(newReportRef, {
                        jobId,
                        reportedBy: username,
                        reason,
                        date: new Date().toISOString()
                    }).then(() => {
                        alert("Report submitted successfully!");
                        loadJobListings();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error submitting report.");
                    });
                });
            }

            function loadSavedJobs() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `saved_jobs/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const savedJobs = snapshot.val();
                        let savedJobsHTML = '<h2>Saved Jobs</h2><ul>';
                        for (const jobId in savedJobs) {
                            const job = savedJobs[jobId];
                            const tags = job.tags || [];  // Ensure tags is defined and is an array
                            savedJobsHTML += `
                                <li>
                                    ${job.title} at ${job.company} - ${job.location}
                                    <div class="tags">
                                        ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                    <button class="apply-button" data-job-id="${jobId}">Apply</button>
                                    <button class="remove-save-button" data-job-id="${jobId}">Remove</button>
                                </li>
                            `;
                        }
                        savedJobsHTML += '</ul>';
                        document.getElementById("content").innerHTML = savedJobsHTML;

                        document.querySelectorAll('.apply-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadApplicationForm(button.getAttribute('data-job-id'));
                            });
                        });

                        document.querySelectorAll('.remove-save-button').forEach(button => {
                            button.addEventListener('click', function () {
                                removeSavedJob(button.getAttribute('data-job-id'));
                            });
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>No saved jobs found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading saved jobs.</p>';
                });
            }

            function removeSavedJob(jobId) {
                const username = sessionStorage.getItem('username');
                remove(ref(db, `saved_jobs/${username}/${jobId}`)).then(() => {
                    alert("Job removed from saved jobs.");
                    loadSavedJobs();
                }).catch((error) => {
                    console.error(error);
                    alert("Error removing saved job.");
                });
            }

            function removeSavedJob(jobId) {
                const username = sessionStorage.getItem('username');
                remove(ref(db, `saved_jobs/${username}/${jobId}`)).then(() => {
                    alert("Job removed from saved jobs.");
                    loadSavedJobs();
                }).catch((error) => {
                    console.error(error);
                    alert("Error removing saved job.");
                });
            }

            function loadCVBuilder() {
                document.getElementById("content").innerHTML = `
                    <h2>CV Builder</h2>
                    <form id="cv-builder-form">
                        <div class="input-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="input-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="input-group">
                            <label for="phone">Phone:</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="input-group">
                            <label for="address">Address:</label>
                            <textarea id="address" rows="2" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="summary">Professional Summary:</label>
                            <textarea id="summary" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="experience">Experience:</label>
                            <textarea id="experience" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="education">Education:</label>
                            <textarea id="education" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="skills">Skills:</label>
                            <textarea id="skills" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Save CV</button>
                        <button type="button" id="download-cv" class="auth-button">Download CV as PDF</button>
                    </form>
                `;

                document.getElementById("cv-builder-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const username = sessionStorage.getItem('username');
                    const name = document.getElementById("name").value;
                    const email = document.getElementById("email").value;
                    const phone = document.getElementById("phone").value;
                    const address = document.getElementById("address").value;
                    const summary = document.getElementById("summary").value;
                    const experience = document.getElementById("experience").value;
                    const education = document.getElementById("education").value;
                    const skills = document.getElementById("skills").value;

                    const cvData = {
                        name,
                        email,
                        phone,
                        address,
                        summary,
                        experience,
                        education,
                        skills
                    };

                    update(ref(db, `resumes/${username}`), cvData).then(() => {
                        alert("CV saved successfully!");
                        loadProfile('job-seeker');
                    }).catch((error) => {
                        console.error(error);
                        alert("Error saving CV.");
                    });
                });

                document.getElementById("download-cv").addEventListener('click', function () {
                    const name = document.getElementById("name").value;
                    const email = document.getElementById("email").value;
                    const phone = document.getElementById("phone").value;
                    const address = document.getElementById("address").value;
                    const summary = document.getElementById("summary").value;
                    const experience = document.getElementById("experience").value;
                    const education = document.getElementById("education").value;
                    const skills = document.getElementById("skills").value;

                    const {jsPDF} = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(20);
                    doc.text("Curriculum Vitae", 20, 20);

                    doc.setFontSize(12);
                    doc.text(`Name: ${name}`, 20, 30);
                    doc.text(`Email: ${email}`, 20, 40);
                    doc.text(`Phone: ${phone}`, 20, 50);
                    doc.text(`Address: ${address}`, 20, 60);
                    doc.text("Professional Summary:", 20, 70);
                    doc.text(summary, 20, 80, {maxWidth: 170});

                    doc.text("Experience:", 20, 100);
                    doc.text(experience, 20, 110, {maxWidth: 170});

                    doc.text("Education:", 20, 130);
                    doc.text(education, 20, 140, {maxWidth: 170});

                    doc.text("Skills:", 20, 160);
                    doc.text(skills, 20, 170, {maxWidth: 170});

                    doc.save("CV.pdf");
                });
            }

            function checkJobAlerts(title, category, location) {
                get(ref(db, 'job_alerts')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const alerts = snapshot.val();
                        for (const username in alerts) {
                            for (const alertId in alerts[username]) {
                                const alert = alerts[username][alertId];
                                if ((alert.jobTitle && alert.jobTitle === title) ||
                                    (alert.jobCategory && alert.jobCategory === category) ||
                                    (alert.location && alert.location === location)) {
                                    notifyUser(username, alert.alertName);
                                }
                            }
                        }
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }

            function notifyUser(username, alertName) {
                alert(`New job matching your alert "${alertName}" has been posted!`);
                // In a real-world application, you would send an email or a notification here.
            }

            function loadCompanyProfiles() {
                const username = sessionStorage.getItem('username');
                document.getElementById("content").innerHTML = `
                    <h2>Company Profiles</h2>
                    <form id="company-profile-form">
                        <div class="input-group">
                            <label for="company-name">Company Name:</label>
                            <input type="text" id="company-name" required>
                        </div>
                        <div class="input-group">
                            <label for="company-website">Company Website:</label>
                            <input type="url" id="company-website" required>
                        </div>
                        <div class="input-group">
                            <label for="company-description">Company Description:</label>
                            <textarea id="company-description" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="company-logo">Company Logo:</label>
                            <input type="file" id="company-logo" accept="image/*">
                        </div>
                        <button type="submit" class="auth-button">Save Company Profile</button>
                    </form>
                    <div id="existing-company-profiles">
                        <h3>Existing Company Profiles</h3>
                        <ul id="company-profiles-list"></ul>
                    </div>
                `;

                document.getElementById("company-profile-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const companyName = document.getElementById("company-name").value;
                    const companyWebsite = document.getElementById("company-website").value;
                    const companyDescription = document.getElementById("company-description").value;
                    const companyLogoInput = document.getElementById("company-logo");
                    const companyLogoFile = companyLogoInput.files[0];

                    if (companyLogoFile) {
                        const logoRef = storageRef(storage, `company_logos/${username}/${companyLogoFile.name}`);
                        uploadBytes(logoRef, companyLogoFile).then((snapshot) => {
                            getDownloadURL(snapshot.ref).then((url) => {
                                saveCompanyProfile(username, companyName, companyWebsite, companyDescription, url);
                            }).catch((error) => {
                                console.error(error);
                                alert("Error uploading company logo.");
                            });
                        }).catch((error) => {
                            console.error(error);
                            alert("Error uploading company logo.");
                        });
                    } else {
                        saveCompanyProfile(username, companyName, companyWebsite, companyDescription);
                    }
                });

                loadExistingCompanyProfiles();
            }

            function saveCompanyProfile(username, companyName, companyWebsite, companyDescription, companyLogoUrl) {
                const profileData = {
                    companyName,
                    companyWebsite,
                    companyDescription,
                    companyLogoUrl
                };

                const newProfileRef = push(ref(db, `company_profiles/${username}`));
                set(newProfileRef, profileData).then(() => {
                    alert("Company profile saved successfully!");
                    loadCompanyProfiles();
                }).catch((error) => {
                    console.error(error);
                    alert("Error saving company profile.");
                });
            }

            function loadExistingCompanyProfiles() {
                const username = sessionStorage.getItem('username');
                get(ref(db, `company_profiles/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const profiles = snapshot.val();
                        let profilesListHTML = '';
                        for (const profileId in profiles) {
                            const profile = profiles[profileId];
                            profilesListHTML += `
                                <li>
                                    <strong>${profile.companyName}</strong> - ${profile.companyWebsite}
                                    <p>${profile.companyDescription}</p>
                                    ${profile.companyLogoUrl ? `<img src="${profile.companyLogoUrl}" alt="Company Logo" width="100">` : ''}
                                </li>
                            `;
                        }
                        document.getElementById("company-profiles-list").innerHTML = profilesListHTML;
                    } else {
                        document.getElementById("company-profiles-list").innerHTML = '<p>No company profiles found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("company-profiles-list").innerHTML = '<p>Error loading company profiles.</p>';
                });
            }

            function loadJobAnalytics() {
                const username = sessionStorage.getItem('username');
                document.getElementById("content").innerHTML = `
                    <h2>Job Analytics</h2>
                    <canvas id="viewsChart" width="400" height="200"></canvas>
                    <canvas id="applicationsChart" width="400" height="200"></canvas>
                `;

                get(ref(db, `job_analytics/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const analytics = snapshot.val();
                        const jobTitles = Object.keys(analytics);
                        const viewsData = jobTitles.map(title => analytics[title].views);
                        const applicationsData = jobTitles.map(title => analytics[title].applications);

                        const ctxViews = document.getElementById('viewsChart').getContext('2d');
                        const ctxApplications = document.getElementById('applicationsChart').getContext('2d');

                        new Chart(ctxViews, {
                            type: 'bar',
                            data: {
                                labels: jobTitles,
                                datasets: [{
                                    label: 'Views',
                                    data: viewsData,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        new Chart(ctxApplications, {
                            type: 'bar',
                            data: {
                                labels: jobTitles,
                                datasets: [{
                                    label: 'Applications',
                                    data: applicationsData,
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>No job analytics data found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading job analytics.</p>';
                });
            }

            function loadBulkJobUploadForm() {
                document.getElementById("content").innerHTML = `
                    <h2>Bulk Job Upload</h2>
                    <form id="bulk-job-upload-form">
                        <div class="input-group">
                            <label for="bulk-job-file">Upload CSV:</label>
                            <input type="file" id="bulk-job-file" accept=".csv" required>
                        </div>
                        <button type="submit" class="auth-button">Upload Jobs</button>
                    </form>
                    <div id="upload-results"></div>
                `;

                document.getElementById("bulk-job-upload-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const fileInput = document.getElementById("bulk-job-file");
                    const file = fileInput.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const text = e.target.result;
                            processCSV(text);
                        };
                        reader.readAsText(file);
                    }
                });
            }

            function processCSV(csvText) {
                const rows = csvText.split('\n');
                const jobs = [];
                const errors = [];

                rows.forEach((row, index) => {
                    const cols = row.split(',');
                    if (cols.length === 5) {
                        jobs.push({
                            title: cols[0].trim(),
                            company: cols[1].trim(),
                            location: cols[2].trim(),
                            category: cols[3].trim(),
                            description: cols[4].trim()
                        });
                    } else {
                        errors.push(`Invalid format at line ${index + 1}`);
                    }
                });

                if (errors.length > 0) {
                    document.getElementById("upload-results").innerHTML = `
                        <h3>Upload Errors</h3>
                        <ul>
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    uploadJobs(jobs);
                }
            }

            function uploadJobs(jobs) {
                const promises = jobs.map(job => {
                    const newJobRef = push(ref(db, 'jobs'));
                    return set(newJobRef, job);
                });

                Promise.all(promises).then(() => {
                    alert("Jobs uploaded successfully!");
                    loadJobListings();
                }).catch((error) => {
                    console.error(error);
                    alert("Error uploading jobs.");
                });
            }

            function loadCandidateManagement() {
                document.getElementById("content").innerHTML = `
                    <h2>Candidate Management</h2>
                    <div class="search-container">
                        <input type="text" id="candidate-search-bar" placeholder="Search for candidates...">
                    </div>
                    <div id="candidates-list"></div>
                `;

                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const jobSeekers = Object.values(users).filter(user => user.Role === 'job-seeker');
                        let candidatesHTML = '<ul>';
                        jobSeekers.forEach(seeker => {
                            candidatesHTML += `
                                <li>
                                    <strong>${seeker.Username}</strong> - ${seeker.Email}
                                    <button class="communicate-button" data-username="${seeker.Username}">Communicate</button>
                                </li>
                            `;
                        });
                        candidatesHTML += '</ul>';
                        document.getElementById("candidates-list").innerHTML = candidatesHTML;

                        document.querySelectorAll('.communicate-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadCommunicationForm(button.getAttribute('data-username'));
                            });
                        });
                    } else {
                        document.getElementById("candidates-list").innerHTML = '<p>No candidates found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("candidates-list").innerHTML = '<p>Error loading candidates.</p>';
                });

                document.getElementById('candidate-search-bar').addEventListener('input', function () {
                    filterCandidates(this.value.toLowerCase());
                });
            }

            function filterCandidates(query) {
                const candidates = document.querySelectorAll('#candidates-list li');
                candidates.forEach(candidate => {
                    const text = candidate.textContent.toLowerCase();
                    if (text.includes(query)) {
                        candidate.style.display = '';
                    } else {
                        candidate.style.display = 'none';
                    }
                });
            }

            function loadCommunicationForm(username) {
                document.getElementById("content").innerHTML = `
                    <h2>Communicate with ${username}</h2>
                    <form id="communication-form">
                        <div class="input-group">
                            <label for="message">Message:</label>
                            <textarea id="message" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="auth-button">Send Message</button>
                    </form>
                `;

                document.getElementById("communication-form").addEventListener('submit', function (e) {
                    e.preventDefault();
                    const message = document.getElementById("message").value;

                    const newMessageRef = push(ref(db, `messages/${username}`));
                    set(newMessageRef, {
                        from: sessionStorage.getItem('username'),
                        message,
                        date: new Date().toISOString()
                    }).then(() => {
                        alert("Message sent successfully!");
                        loadCandidateManagement();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error sending message.");
                    });
                });
            }

            function loadManageUsers() {
                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        let usersHTML = '<h2>Manage Users</h2>';
                        usersHTML += '<div class="moderation-container" id="user-profiles-list">';
                        for (const username in users) {
                            const user = users[username];
                            usersHTML += `
                                <div class="moderation-item">
                                    <p><strong>Username:</strong> ${user.Username}</p>
                                    <p><strong>Email:</strong> ${user.Email}</p>
                                    <p><strong>Role:</strong> ${user.Role}</p>
                                    <div class="moderation-actions">
                                        <button class="edit-user-button" data-username="${username}">Edit</button>
                                        <button class="delete-user-button" data-username="${username}">Delete</button>
                                    </div>
                                </div>
                            `;
                        }
                        usersHTML += '</div>';
                        document.getElementById("content").innerHTML = usersHTML;

                        document.querySelectorAll('.edit-user-button').forEach(button => {
                            button.addEventListener('click', function () {
                                loadEditUserForm(button.getAttribute('data-username'));
                            });
                        });

                        document.querySelectorAll('.delete-user-button').forEach(button => {
                            button.addEventListener('click', function () {
                                deleteUser(button.getAttribute('data-username'));
                            });
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>No users found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading users.</p>';
                });
            }

            function loadEditUserForm(username) {
                get(ref(db, `users/${username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const user = snapshot.val();
                        document.getElementById("content").innerHTML = `
                            <h2>Edit User</h2>
                            <form id="edit-user-form">
                                <div class="input-group">
                                    <label for="edit-username">Username:</label>
                                    <input type="text" id="edit-username" value="${user.Username}" required>
                                </div>
                                <div class="input-group">
                                    <label for="edit-email">Email:</label>
                                    <input type="email" id="edit-email" value="${user.Email}" required>
                                </div>
                                <div class="input-group">
                                    <label for="edit-role">Role:</label>
                                    <select id="edit-role" required>
                                        <option value="admin" ${user.Role === 'admin' ? 'selected' : ''}>Admin</option>
                                        <option value="employer" ${user.Role === 'employer' ? 'selected' : ''}>Employer</option>
                                        <option value="job-seeker" ${user.Role === 'job-seeker' ? 'selected' : ''}>Job Seeker</option>
                                    </select>
                                </div>
                                <button type="submit" class="auth-button">Save Changes</button>
                            </form>
                        `;

                        document.getElementById("edit-user-form").addEventListener('submit', function (e) {
                            e.preventDefault();
                            const updatedUsername = document.getElementById("edit-username").value;
                            const updatedEmail = document.getElementById("edit-email").value;
                            const updatedRole = document.getElementById("edit-role").value;

                            const updates = {
                                Username: updatedUsername,
                                Email: updatedEmail,
                                Role: updatedRole
                            };

                            update(ref(db, `users/${username}`), updates).then(() => {
                                alert("User updated successfully!");
                                loadManageUsers();
                            }).catch((error) => {
                                console.error(error);
                                alert("Error updating user.");
                            });
                        });
                    } else {
                        document.getElementById("content").innerHTML = '<p>User not found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>Error loading user data.</p>';
                });
            }

            function deleteUser(username) {
                if (confirm("Are you sure you want to delete this user?")) {
                    remove(ref(db, `users/${username}`)).then(() => {
                        alert("User deleted successfully!");
                        loadManageUsers();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error deleting user.");
                    });
                }
            }

            function loadContentModeration() {
                document.getElementById("content").innerHTML = `
                    <h2>Content Moderation</h2>
                    <div id="job-postings-moderation">
                        <h3>Job Postings</h3>
                        <p>No job postings found for moderation.</p>
                    </div>
                    <div id="user-profiles-moderation">
                        <h3>User Profiles</h3>
                        <div class="moderation-container" id="user-profiles-list">
                        </div>
                    </div>
                    <div id="reported-content-moderation">
                        <h3>Reported Content</h3>
                        <div class="moderation-container" id="reported-content-list">
                        </div>
                    </div>
                `;

                loadUserProfilesForModeration();
                loadReportedContentForModeration();
            }

            function loadUserProfilesForModeration() {
                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        let profilesHTML = '';
                        for (const username in users) {
                            const user = users[username];
                            profilesHTML += `
                                <div class="moderation-item">
                                    <p><strong>Username:</strong> ${user.Username}</p>
                                    <p><strong>Email:</strong> ${user.Email}</p>
                                    <p><strong>Role:</strong> ${user.Role}</p>
                                    <div class="moderation-actions">
                                        <button class="approve-button" data-username="${username}">Approve</button>
                                        <button class="reject-button" data-username="${username}">Reject</button>
                                    </div>
                                </div>
                            `;
                        }
                        document.getElementById("user-profiles-list").innerHTML = profilesHTML;

                        document.querySelectorAll('.approve-button').forEach(button => {
                            button.addEventListener('click', function () {
                                approveUserProfile(button.getAttribute('data-username'));
                            });
                        });

                        document.querySelectorAll('.reject-button').forEach(button => {
                            button.addEventListener('click', function () {
                                rejectUserProfile(button.getAttribute('data-username'));
                            });
                        });
                    } else {
                        document.getElementById("user-profiles-list").innerHTML = '<p>No user profiles found for moderation.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("user-profiles-list").innerHTML = '<p>Error loading user profiles.</p>';
                });
            }

            function loadReportedContentForModeration() {
                get(ref(db, 'reports')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const reports = snapshot.val();
                        let reportsHTML = '';
                        for (const jobId in reports) {
                            const jobReports = reports[jobId];
                            for (const reportId in jobReports) {
                                const report = jobReports[reportId];
                                reportsHTML += `
                                    <div class="moderation-item">
                                        <p><strong>Job ID:</strong> ${report.jobId}</p>
                                        <p><strong>Reported By:</strong> ${report.reportedBy}</p>
                                        <p><strong>Reason:</strong> ${report.reason}</p>
                                        <p><strong>Date:</strong> ${new Date(report.date).toLocaleString()}</p>
                                        <div class="moderation-actions">
                                            <button class="delete-job-button" data-job-id="${report.jobId}">Delete Job</button>
                                            <button class="ignore-report-button" data-job-id="${report.jobId}">Ignore Report</button>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        document.getElementById("reported-content-list").innerHTML = reportsHTML;

                        document.querySelectorAll('.delete-job-button').forEach(button => {
                            button.addEventListener('click', function () {
                                deleteJob(button.getAttribute('data-job-id'));
                            });
                        });

                        document.querySelectorAll('.ignore-report-button').forEach(button => {
                            button.addEventListener('click', function () {
                                ignoreReport(button.getAttribute('data-job-id'));
                            });
                        });
                    } else {
                        document.getElementById("reported-content-list").innerHTML = '<p>No reported content found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById("reported-content-list").innerHTML = '<p>Error loading reported content.</p>';
                });
            }

            function approveUserProfile(username) {
                alert(`User profile for ${username} approved.`);
                // Additional actions for approving the user profile can be added here
            }

            function rejectUserProfile(username) {
                alert(`User profile for ${username} rejected.`);
                // Additional actions for rejecting the user profile can be added here
            }

            function deleteJob(jobId) {
                if (confirm("Are you sure you want to delete this job?")) {
                    remove(ref(db, `jobs/${jobId}`)).then(() => {
                        alert("Job deleted successfully!");
                        loadReportedContentForModeration();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error deleting job.");
                    });
                }
            }

            function ignoreReport(jobId) {
                if (confirm("Are you sure you want to ignore this report?")) {
                    remove(ref(db, `reports/${jobId}`)).then(() => {
                        alert("Report ignored successfully!");
                        loadReportedContentForModeration();
                    }).catch((error) => {
                        console.error(error);
                        alert("Error ignoring report.");
                    });
                }
            }

            function loadAnalytics() {
                document.getElementById("content").innerHTML = `
                    <h2>Platform Analytics</h2>
                    <div class="analytics-container">
                        <div class="chart-container">
                            <div class="chart-box">
                                <canvas id="platformUsageChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <canvas id="userEngagementChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <canvas id="jobPostingEffectivenessChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                loadPlatformUsage();
                loadUserEngagement();
                loadJobPostingEffectiveness();
            }

            function loadPlatformUsage() {
                get(ref(db, 'platform_usage')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const usageData = snapshot.val();
                        const labels = Object.keys(usageData);
                        const data = Object.values(usageData);

                        const ctx = document.getElementById('platformUsageChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Platform Usage',
                                    data: data,
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('platformUsageChart').innerHTML = '<p>No platform usage data found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById('platformUsageChart').innerHTML = '<p>Error loading platform usage data.</p>';
                });
            }

            function loadUserEngagement() {
                get(ref(db, 'user_engagement')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const engagementData = snapshot.val();
                        const labels = Object.keys(engagementData);
                        const data = Object.values(engagementData);

                        const ctx = document.getElementById('userEngagementChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'User Engagement',
                                    data: data,
                                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                    borderColor: 'rgba(255, 206, 86, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('userEngagementChart').innerHTML = '<p>No user engagement data found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById('userEngagementChart').innerHTML = '<p>Error loading user engagement data.</p>';
                });
            }

            function loadJobPostingEffectiveness() {
                get(ref(db, 'job_posting_effectiveness')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const effectivenessData = snapshot.val();
                        const labels = Object.keys(effectivenessData);
                        const data = Object.values(effectivenessData);

                        const ctx = document.getElementById('jobPostingEffectivenessChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Job Posting Effectiveness',
                                    data: data,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('jobPostingEffectivenessChart').innerHTML = '<p>No job posting effectiveness data found.</p>';
                    }
                }).catch((error) => {
                    console.error(error);
                    document.getElementById('jobPostingEffectivenessChart').innerHTML = '<p>Error loading job posting effectiveness data.</p>';
                });
            }

            setUpDashboard(role);
        });
    </script>
</body>

</html>